# Simulating Regev's quantum factoring algorithm
The repository contains a [Sage](https://www.sagemath.org) script [<code>simulator.sage</code>](simulator.sage) that implements a simulator for the quantum part of Regev's variation [[Regev23]](https://doi.org/10.48550/arXiv.2308.06572) of Shor's factoring algorithm [[Shor94]](https://doi.org/10.1109/SFCS.1994.365700). The [<code>simulator.sage</code>](simulator.sage) script furthermore implements Regev's classical lattice-based post-processing algorithm from [[Regev23]](https://doi.org/10.48550/arXiv.2308.06572) with minor improvements to attempt to factor $N$ completely using all available factoring relations.

The simulator works for integers $N$ on special form, allowing the quantum part of Regev's algorithm to be simulated for large cryptographically relevant (but insecure) integers $N$ for which the factorization is known. It is efficient enough to simulate Regev's algorithm for 2048-bit RSA integers.

To support the [<code>simulator.sage</code>](simulator.sage) script, this repository also contains a [Sage](https://www.sagemath.org) script [<code>factor-collection.sage</code>](factor-collection.sage) that is an excerpt from the [<code>factor.sage</code>](https://github.com/ekera/factoritall/blob/master/factor.sage) script in the [factoritall](https://www.github.com/ekera/factoritall) repository, and a [Python3](https://www.python.org) script [<code>timer.py</code>](timer.py) that is copied from the [factoritall](https://www.github.com/ekera/factoritall) repository.

The aforementioned scripts were developed for academic research purposes. They grew out of our research project in an organic manner as research questions were posed and answered. They are distributed "as is" without warranty of any kind, either expressed or implied. For further details, see the [license](LICENSE.md).

## Prerequisites
To install [Sage](https://www.sagemath.org) under [Ubuntu 22.04 LTS](https://releases.ubuntu.com/22.04), simply execute:

```console
$ sudo apt install sagemath
```
For other Linux and Unix distributions, or operating systems, you may need to [download Sage](https://www.sagemath.org/download) and install it manually. These scripts were developed for Sage 9.5.

### Attaching the scripts
Launch Sage and attach the [<code>factor-collection.sage</code>](factor-collection.sage) and [<code>simulator.sage</code>](simulator.sage) scripts by executing:

```console
$ sage
(..)
sage: %attach factor-collection.sage
sage: %attach simulator.sage
```

## Examples

### Simulating the quantum algorithm
To simulate factoring an integer $N$ of length $n$ bits with $m$ distinct prime factors, each of length $l$ bits, first setup such an integer on special form by executing:

```console
sage: [N, factors] = sample_integer(m = 2, l = 1024)
Sampling N on special form to enable efficient simulation...
 Sampled factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
 Sampled factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399

 Sampled N = 28759896118456827161563854042134498013014087125987160020543411119988219828474882210335075467862502629425620131030806200333203261231173338373172731515221865502539584104022765713302688744872137663115947073803713180869081684737881126081049125912452463234120601190349760336719567479109696004557335655480818472257527311294268484573499101424987022290819145005706565642527771856212147523728704614058754458495370070149324584452346197934004171764250499142691941802321123144199186196139066004799558072567554997041078522760226746159978355404132121522391908519353222397419195996801905364912806273030705031620665722625985564569733

 Time required to sample: 15 sec 117 ms 925 µs
```

This yields $N$ and the prime factors of $N$.
Then setup the simulator by executing:

```console
sage: simulator = Simulator(N, factors)
Setting up the simulator...
 Picking parameters...
  n = 2048
  d = 46

  C = 2
  R = 1762483107300123635910219392
  D = 39614081257132168796771975168

 Sampling vectors from L...
  Sampling vectors 1 to 8 of 54 using 8 threads...
  Sampling vectors 9 to 16 of 54 using 8 threads...
  Sampling vectors 17 to 24 of 54 using 8 threads...
  Sampling vectors 25 to 32 of 54 using 8 threads...
  Sampling vectors 33 to 40 of 54 using 8 threads...
  Sampling vectors 41 to 48 of 54 using 8 threads...
  Sampling vectors 49 to 54 of 54 using 8 threads...

 Reducing the basis for L, this may take a moment...
 Computing the basis for the dual L^* of L...
 Computing the Gram–Schmidt orthogonalization of the basis...

 Time required to setup the simulator: 9 min 0 sec 906 ms 189 µs
```

Finally, simulate running the quantum algorithm $\eta = \lceil\sqrt{n}\rceil + 4$ times by executing:

```console
sage: [samples, [d, R]] = simulator.sample_vectors()
Sampling vectors...
 Sampled a good vector for sample 1 of 50 samples...
 Sampled a good vector for sample 2 of 50 samples...
 Sampled a good vector for sample 3 of 50 samples...
 Sampled a good vector for sample 4 of 50 samples...
 Sampled a good vector for sample 5 of 50 samples...
 Sampled a good vector for sample 6 of 50 samples...
 Sampled a good vector for sample 7 of 50 samples...
 Sampled a good vector for sample 8 of 50 samples...
 Sampled a good vector for sample 9 of 50 samples...
 Sampled a good vector for sample 10 of 50 samples...
 Sampled a good vector for sample 11 of 50 samples...
 Sampled a good vector for sample 12 of 50 samples...
 Sampled a good vector for sample 13 of 50 samples...
 Sampled a good vector for sample 14 of 50 samples...
 Sampled a good vector for sample 15 of 50 samples...
 Sampled a good vector for sample 16 of 50 samples...
 Sampled a good vector for sample 17 of 50 samples...
 Sampled a good vector for sample 18 of 50 samples...
 Sampled a good vector for sample 19 of 50 samples...
 Sampled a good vector for sample 20 of 50 samples...
 Sampled a good vector for sample 21 of 50 samples...
 Sampled a good vector for sample 22 of 50 samples...
 Sampled a good vector for sample 23 of 50 samples...
 Sampled a good vector for sample 24 of 50 samples...
 Sampled a good vector for sample 25 of 50 samples...
 Sampled a good vector for sample 26 of 50 samples...
 Sampled a good vector for sample 27 of 50 samples...
 Sampled a good vector for sample 28 of 50 samples...
 Sampled a good vector for sample 29 of 50 samples...
 Sampled a good vector for sample 30 of 50 samples...
 Sampled a good vector for sample 31 of 50 samples...
 Sampled a good vector for sample 32 of 50 samples...
 Sampled a good vector for sample 33 of 50 samples...
 Sampled a good vector for sample 34 of 50 samples...
 Sampled a good vector for sample 35 of 50 samples...
 Sampled a good vector for sample 36 of 50 samples...
 Sampled a good vector for sample 37 of 50 samples...
 Sampled a good vector for sample 38 of 50 samples...
 Sampled a good vector for sample 39 of 50 samples...
 Sampled a good vector for sample 40 of 50 samples...
 Sampled a good vector for sample 41 of 50 samples...
 Sampled a good vector for sample 42 of 50 samples...
 Sampled a good vector for sample 43 of 50 samples...
 Sampled a good vector for sample 44 of 50 samples...
 Sampled a good vector for sample 45 of 50 samples...
 Sampled a good vector for sample 46 of 50 samples...
 Sampled a good vector for sample 47 of 50 samples...
 Sampled a good vector for sample 48 of 50 samples...
 Sampled a good vector for sample 49 of 50 samples...
 Sampled a good vector for sample 50 of 50 samples...

 Time required to sample: 17 sec 332 ms 827 µs
```

This yields the samples, and parameters $d$ and $R$ setup as explained in [[Regev23]](https://doi.org/10.48550/arXiv.2308.06572).

### Executing the classical post-processing
To solve the $\lceil\sqrt{n}\rceil + 4$ samples for the factors of $N$, execute:

```console
sage: solve_samples_for_factors(samples, N, d, R)
Post-processing the sampled vectors to find factors...
 Building the post-processing matrix...
 Running LLL on the post-processing matrix...

 Processing the factoring relations found...
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399
  Found factor: 168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067

 Time required to post-process: 48 sec 442 ms 675 µs
{168703144280006974669021458045577608597557808854566190046790829143300485520188564349123086107805724872000378744974611722069123231110571092240320154708249388823918176754495265763639511022544262171425250921636722500018815655683730762074545173135817035742098124464990162003455894684641023503487504183899091245067, 170476349099470608547764399126561246988310605246696244617079779233562261208499488682022175358930346396414050109935917989269343006918537498292778825370830807153642390128078684768448041303272918458230048253282022355849387893336810344516483372333743565628823615375930536668088621883887475157836549291893820564399}
```

### Convenience test function
There is a also a convenience test function that performs the above procedure given $m$ and $l$.

To try it out, execute:

```console
sage: test(m = 8, l = 32)
Sampling N on special form to enable efficient simulation...
 Sampled factor: 2451410603
 Sampled factor: 2770140707
 Sampled factor: 4033549019
 Sampled factor: 3570474647
 Sampled factor: 2167929563
 Sampled factor: 3389231123
 Sampled factor: 3584196983
 Sampled factor: 2712513599

 Sampled N = 6986205075059779329460146596762236881695138018106109507925142091998584616949

 Time required to sample: 4 sec 344 ms 973 µs

** Setting up the simulator...

Setting up the simulator...
 Picking parameters...
  n = 252
  d = 16

  C = 2
  R = 3609159443
  D = 34359738368

 Sampling vectors from L...
  Sampling vectors 1 to 8 of 24 using 8 threads...
  Sampling vectors 9 to 16 of 24 using 8 threads...
  Sampling vectors 17 to 24 of 24 using 8 threads...

 Reducing the basis for L, this may take a moment...
 Computing the basis for the dual L^* of L...
 Computing the Gram–Schmidt orthogonalization of the basis...

 Time required to setup the simulator: 1 sec 126 ms 924 µs

** Using the simulator to sample vectors...

Sampling vectors...
 Sampled a good vector for sample 1 of 20 samples...
 Sampled a good vector for sample 2 of 20 samples...
 Sampled a good vector for sample 3 of 20 samples...
 Sampled a good vector for sample 4 of 20 samples...
 Sampled a good vector for sample 5 of 20 samples...
 Sampled a good vector for sample 6 of 20 samples...
 Sampled a good vector for sample 7 of 20 samples...
 Sampled a good vector for sample 8 of 20 samples...
 Sampled a good vector for sample 9 of 20 samples...
 Sampled a good vector for sample 10 of 20 samples...
 Sampled a good vector for sample 11 of 20 samples...
 Sampled a good vector for sample 12 of 20 samples...
 Sampled a good vector for sample 13 of 20 samples...
 Sampled a good vector for sample 14 of 20 samples...
 Sampled a good vector for sample 15 of 20 samples...
 Sampled a good vector for sample 16 of 20 samples...
 Sampled a good vector for sample 17 of 20 samples...
 Sampled a good vector for sample 18 of 20 samples...
 Sampled a good vector for sample 19 of 20 samples...
 Sampled a good vector for sample 20 of 20 samples...

 Time required to sample: 115 ms 865 µs

** Post-processing the sampled vectors to find factors...

Post-processing the sampled vectors to find factors...
 Building the post-processing matrix...
 Running LLL on the post-processing matrix...

 Processing the factoring relations found...
  Found factor: 5880538421311627237
  Found factor: 706339586902580715294808765310991516306907886408454596881
  Found factor: 35304442108314028981919569679
  Found factor: 58162742291148812184335859349851819673
  Found factor: 39214901935659457704951697523
  Found factor: 62429664276632226709045731686482610317
  Found factor: 142580763152078711239536516123343437225236192819
  Found factor: 208407028399219829569235536997926805685983276747
  Found factor: 33521926437515156975622216767
  Found factor: 706339586902580715294808765310991516306907886408454596881
  Found factor: 82176005901910672783249714704988180501
  Found factor: 1732024339397219887724921336021635412705799576674516053011711791471
  Found factor: 840860755904521368206228816212904444579687299012914175621
  Found factor: 37869568296931650560086444259
  Found factor: 255056326992965003571302893786409524964208787151
  Found factor: 80466502281696898657864468741641690457

 Time required to post-process: 507 ms 190 µs

{3389231123, 3570474647, 4033549019, 2167929563, 2770140707, 2451410603, 3584196983, 2712513599}
```

## About and acknowledgments
These scripts were developed by [Martin Ekerå](mailto:ekera@kth.se) and Joel Gärtner, in part at [KTH, the Royal Institute of Technology](https://www.kth.se/en), in Stockholm, [Sweden](https://www.sweden.se). Martin Ekerå thanks Sam Jaques for useful discussions.

Funding and support was provided by the Swedish NCSA that is a part of the [Swedish Armed Forces](https://www.mil.se).